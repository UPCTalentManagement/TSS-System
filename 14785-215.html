<!-- this Dashboard is made by Dr Mahmoud Hesham - eLearning & EdTech Innovator -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Department Project Management Dashboard">
    <meta name="author" content="Dr Mahmoud Hesham">
    <title>Project Management Dashboard</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        .control-group input,
        .control-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .urgent-tasks-panel {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
            margin-bottom: 30px;
        }

        .urgent-tasks-panel h2 {
            color: white;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .urgent-task-item {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #ff5252;
            transition: all 0.3s;
        }

        .urgent-task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .urgent-task-item:last-child {
            margin-bottom: 0;
        }

        .urgent-task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .urgent-task-title {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .urgent-task-project {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .urgent-task-details {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.9em;
            color: #555;
        }

        .urgent-task-details span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .urgent-badge {
            background: #ff5252;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        .content-grid {
            display: grid;
            gap: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-header h2 {
            color: #333;
            font-size: 1.5em;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #e9ecef;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }

        .status-not-started {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-in-progress {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-completed {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status-on-hold {
            background: #fce4ec;
            color: #c2185b;
        }

        .priority-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .priority-high {
            background: #ffebee;
            color: #c62828;
        }

        .priority-medium {
            background: #fff3e0;
            color: #ef6c00;
        }

        .priority-low {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .urgent-indicator {
            animation: pulse 2s infinite;
            color: #ff5252;
            font-weight: bold;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            border-radius: 10px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        #gantt-chart {
            min-height: 400px;
        }

        .api-config {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .api-config input {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border: 2px solid #ffc107;
            border-radius: 5px;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .filter-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                grid-template-columns: 1fr;
            }

            th, td {
                padding: 10px;
                font-size: 0.9em;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .urgent-task-details {
                flex-direction: column;
                gap: 5px;
            }

            .filter-actions {
                flex-direction: column;
            }
        }

        .refresh-indicator {
            display: inline-block;
            font-size: 0.9em;
            color: #666;
            margin-left: 10px;
        }

        .no-urgent-tasks {
            text-align: center;
            padding: 30px;
            color: white;
            font-size: 1.1em;
        }
        .projects-overview {
    margin-bottom: 30px;
}

.projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.project-card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: all 0.3s;
    border-left: 6px solid;
    position: relative;
    overflow: hidden;
}

.project-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    cursor: pointer;
}

.project-card.status-green {
    border-left-color: #28a745;
}

.project-card.status-yellow {
    border-left-color: #ffc107;
}

.project-card.status-red {
    border-left-color: #dc3545;
}

.project-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.project-card-title {
    font-size: 1.3em;
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
    flex: 1;
}

.project-status-indicator {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    flex-shrink: 0;
    margin-left: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    animation: pulse-subtle 2s infinite;
}

@keyframes pulse-subtle {
    0%, 100% { 
        transform: scale(1);
        opacity: 1;
    }
    50% { 
        transform: scale(1.1);
        opacity: 0.8;
    }
}

.project-status-indicator.green {
    background: #28a745;
}

.project-status-indicator.yellow {
    background: #ffc107;
}

.project-status-indicator.red {
    background: #dc3545;
}

.project-card-body {
    color: #666;
}

.project-card-note {
    font-size: 0.95em;
    line-height: 1.6;
    margin-bottom: 15px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 3px solid #dee2e6;
}

.project-card-note.warning {
    background: #fff3cd;
    border-left-color: #ffc107;
    color: #856404;
}

.project-card-note.danger {
    background: #f8d7da;
    border-left-color: #dc3545;
    color: #721c24;
}

.project-card-note.success {
    background: #d4edda;
    border-left-color: #28a745;
    color: #155724;
}

.project-stats {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.project-stat-item {
    display: flex;
    flex-direction: column;
}

.project-stat-label {
    font-size: 0.8em;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 3px;
}

.project-stat-value {
    font-size: 1.5em;
    font-weight: bold;
    color: #667eea;
}

.project-card-footer {
    margin-top: 15px;
    font-size: 0.85em;
    color: #999;
}
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(75, 158, 162, 0.3);
    border-top-color: #4b9ea2;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 15px auto;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
@media (max-width: 768px) {
    .projects-grid {
        grid-template-columns: 1fr;
    }
}
.btn.btn-info {
            background: #17a2b8;
            color: white;
            margin: 3px;
        }
        .btn.btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
footer {
            margin-top: 50px;
            text-align: center;
            font-size: 14px;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> Department Project Management Dashboard üìä </h1>
            <!-- <p> Quickly manage and track The department's projects and tasks.</p> -->
            
            <button class="btn btn-info" onclick="window.location.href='14785-1.html'">
                Manage Tasks üìù
            </button>
            <button class="btn btn-primary" onclick="loadData()">üîÑ Refresh Tasks </button>
            <button class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Clear All Filters</button>
            
            <!-- <div class="api-config">
                <strong>‚öôÔ∏è Google Apps Script URL:</strong>
                <input type="text" id="apiUrl" placeholder="Paste your Google Apps Script Web App URL here" value="">
                <small style="display: block; margin-top: 5px; color: #856404;">
                    Deploy your Google Apps Script as a Web App and paste the URL above. Then click "Load Data".
                </small>
            </div> -->

            <div class="controls">
                <div class="control-group">
                    <label for="projectFilter">Filter by Project:</label>
                    <select id="projectFilter">
                        <option value="">All Projects</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="responsibleFilter">Filter by Responsible:</label>
                    <select id="responsibleFilter">
                        <option value="">All Team Members</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="revisedByFilter">Filter by Revised By:</label>
                    <select id="revisedByFilter">
                        <option value="">All Reviewers</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="statusFilter">Filter by Status:</label>
                    <select id="statusFilter">
                        <option value="">All Status</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="priorityFilter">Filter by Priority:</label>
                    <select id="priorityFilter">
                        <option value="">All Priorities</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="searchInput">Search Tasks:</label>
                    <input type="text" id="searchInput" placeholder="Search by task name...">
                </div>
            </div>

            <div class="filter-section">
                <!-- <h3>üìÖ Advanced Date Filters</h3> -->
                <div class="controls">
                    <div class="control-group">
                        <label for="startDateFrom">Start Date From:</label>
                        <input type="date" id="startDateFrom">
                    </div>
                    <div class="control-group">
                        <label for="startDateTo">Start Date To:</label>
                        <input type="date" id="startDateTo">
                    </div>
                    <div class="control-group">
                        <label for="endDateFrom">End Date From:</label>
                        <input type="date" id="endDateFrom">
                    </div>
                    <div class="control-group">
                        <label for="endDateTo">End Date To:</label>
                        <input type="date" id="endDateTo">
                    </div>
                    <div class="control-group">
                        <label for="deadlineFrom">Deadline From:</label>
                        <input type="date" id="deadlineFrom">
                    </div>
                    <div class="control-group">
                        <label for="deadlineTo">Deadline To:</label>
                        <input type="date" id="deadlineTo">
                    </div>
                </div>
                <div class="filter-actions">
                    <!-- <button class="btn btn-primary" onclick="loadData()">üîÑ Load Data</button> -->
                    <!-- <button class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Clear All Filters</button> -->
                </div>
            </div>
            <div class="spinner" id="spinner" style="display:none;"></div>
        </div>
        <div class="projects-overview">
            <div class="card">
                <div class="card-header">
                    <h2>üìÅ Projects Overview</h2>
                    </div>
                    <div class="projects-grid" id="projectsGrid">
                        <!-- Project cards will be inserted here -->
                </div>
            </div>
        </div>
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Total Tasks</h3>
                <div class="value" id="totalTasks">0</div>
            </div>
            <div class="stat-card">
                <h3>In Progress</h3>
                <div class="value" id="inProgressTasks">0</div>
            </div>
            <div class="stat-card">
                <h3>Completed</h3>
                <div class="value" id="completedTasks">0</div>
            </div>
            <div class="stat-card">
                <h3>Not Started</h3>
                <div class="value" id="notStartedTasks">0</div>
            </div>
            <div class="stat-card">
                <h3>On Hold</h3>
                <div class="value" id="onHoldTasks">0</div>
            </div>
            <div class="stat-card">
                <h3>Urgent Tasks</h3>
                <div class="value urgent-indicator" id="urgentTasks">0</div>
            </div>
        </div>

        <div class="urgent-tasks-panel" id="urgentTasksPanel">
            <h2>üî• Urgent Tasks (Starting or Ending Within 3 Days)</h2>
            <div id="urgentTasksList">
                <div class="no-urgent-tasks">No urgent tasks at this time</div>
            </div>
        </div>

        <div class="content-grid">
            <div class="card">
                <div class="card-header">
                    <h2>üìà Project Timeline (Gantt Chart)</h2>
                    <span class="refresh-indicator" id="lastUpdate"></span>
                </div>
                <div id="gantt-chart"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>üìã Task List</h2>
                    <span id="taskCount">0 tasks</span>
                </div>
                <div class="table-container">
                    <table id="taskTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">Project Name ‚Üï</th>
                                <th onclick="sortTable(1)">Task Name ‚Üï</th>
                                <th onclick="sortTable(2)">Responsible ‚Üï</th>
                                <th onclick="sortTable(3)">Revised By ‚Üï</th>
                                <th onclick="sortTable(4)">Start Date ‚Üï</th>
                                <th onclick="sortTable(5)">End Date ‚Üï</th>
                                <th onclick="sortTable(6)">Deadline ‚Üï</th>
                                <th onclick="sortTable(7)">Status ‚Üï</th>
                                <th onclick="sortTable(8)">Progress ‚Üï</th>
                                <th onclick="sortTable(9)">Priority ‚Üï</th>
                            </tr>
                        </thead>
                        <tbody id="taskTableBody">
                            <tr>
                                <td colspan="10" class="loading">Configure API URL and click "Load Data" to begin</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <footer>
        Made with ‚ù§Ô∏è by Dr Mahmoud - 2025 </a>
    </footer>

    <script>
        if (sessionStorage.getItem("authenticated") !== "true") {
            window.location.href = "loginPageFin.html";
        }
        let allTasks = [];
        let currentSort = { column: -1, ascending: true };

        // Load Google Charts
        google.charts.load('current', {'packages':['gantt']});

        async function loadData() {
            const apiUrl = "https://script.google.com/macros/s/AKfycbxmVOeNR3YQPTYpksHhZr6ajLjXmwua_eJhG1UgzhKdhddY4hakCS6R5okR30vUmAfQ/exec";
            
            if (!apiUrl) {
                alert('‚ö†Ô∏è Please enter your Google Apps Script Web App URL first!');
                return;
            }
            const spinner = document.getElementById("spinner");

            spinner.style.display = "block";     
    
            document.getElementById('taskTableBody').innerHTML = '<tr><td colspan="10" class="loading">Loading data...</td></tr>';
            document.getElementById('gantt-chart').innerHTML = '<div class="loading">Loading Gantt chart...</div>';

            try {
                const response = await fetch(apiUrl);
                const result = await response.json();

                if (result.success) {
                    allTasks = result.data;
                    populateFilters();
                    updateStatistics();
                    renderUrgentTasks();
                    renderTable();
                    renderGanttChart();
                     renderProjectCards();
                    
                    document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                    spinner.style.display = "none";
                } else {
                    throw new Error(result.error || 'Failed to load data');
                }
            } catch (error) {
                document.getElementById('taskTableBody').innerHTML = `
                    <tr><td colspan="10" class="error">
                        ‚ùå Error loading data: ${error.message}<br>
                        Please check your API URL and ensure the Google Apps Script is deployed correctly.
                    </td></tr>
                `;
                document.getElementById('gantt-chart').innerHTML = `<div class="error">Failed to load Gantt chart</div>`;
                
            }
        }

        function populateFilters() {
            const projects = [...new Set(allTasks.map(t => t['Project Name']))].filter(Boolean);
            const responsible = [...new Set(allTasks.map(t => t['Responsible']))].filter(Boolean);
            const revisedBy = [...new Set(allTasks.map(t => t['Revised by']))].filter(Boolean);
            const statuses = [...new Set(allTasks.map(t => t['Status']))].filter(Boolean);
            const priorities = [...new Set(allTasks.map(t => t['Priority']))].filter(Boolean);

            const projectFilter = document.getElementById('projectFilter');
            projectFilter.innerHTML = '<option value="">All Projects</option>' + 
                projects.map(p => `<option value="${p}">${p}</option>`).join('');

            const responsibleFilter = document.getElementById('responsibleFilter');
            responsibleFilter.innerHTML = '<option value="">All Team Members</option>' + 
                responsible.map(r => `<option value="${r}">${r}</option>`).join('');

            const revisedByFilter = document.getElementById('revisedByFilter');
            revisedByFilter.innerHTML = '<option value="">All Reviewers</option>' + 
                revisedBy.map(r => `<option value="${r}">${r}</option>`).join('');

            const statusFilter = document.getElementById('statusFilter');
            statusFilter.innerHTML = '<option value="">All Status</option>' + 
                statuses.map(s => `<option value="${s}">${s}</option>`).join('');

            const priorityFilter = document.getElementById('priorityFilter');
            priorityFilter.innerHTML = '<option value="">All Priorities</option>' + 
                priorities.map(p => `<option value="${p}">${p}</option>`).join('');
        }

        function getFilteredTasks() {
            const projectFilter = document.getElementById('projectFilter').value;
            const responsibleFilter = document.getElementById('responsibleFilter').value;
            const revisedByFilter = document.getElementById('revisedByFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            
            const startDateFrom = document.getElementById('startDateFrom').value;
            const startDateTo = document.getElementById('startDateTo').value;
            const endDateFrom = document.getElementById('endDateFrom').value;
            const endDateTo = document.getElementById('endDateTo').value;
            const deadlineFrom = document.getElementById('deadlineFrom').value;
            const deadlineTo = document.getElementById('deadlineTo').value;

            return allTasks.filter(task => {
                const matchProject = !projectFilter || task['Project Name'] === projectFilter;
                const matchResponsible = !responsibleFilter || task['Responsible'] === responsibleFilter;
                const matchRevisedBy = !revisedByFilter || task['Revised by'] === revisedByFilter;
                const matchStatus = !statusFilter || task['Status'] === statusFilter;
                const matchPriority = !priorityFilter || task['Priority'] === priorityFilter;
                const matchSearch = !searchQuery || 
                    (task['Task Name'] || '').toLowerCase().includes(searchQuery) ||
                    (task['Project Name'] || '').toLowerCase().includes(searchQuery);

                // Date filters
                const taskStartDate = parseDate(task['Start Date']);
                const taskEndDate = parseDate(task['End Date']);
                const taskDeadline = parseDate(task['Deadline']);

                const matchStartDateFrom = !startDateFrom || !taskStartDate || taskStartDate >= new Date(startDateFrom);
                const matchStartDateTo = !startDateTo || !taskStartDate || taskStartDate <= new Date(startDateTo);
                const matchEndDateFrom = !endDateFrom || !taskEndDate || taskEndDate >= new Date(endDateFrom);
                const matchEndDateTo = !endDateTo || !taskEndDate || taskEndDate <= new Date(endDateTo);
                const matchDeadlineFrom = !deadlineFrom || !taskDeadline || taskDeadline >= new Date(deadlineFrom);
                const matchDeadlineTo = !deadlineTo || !taskDeadline || taskDeadline <= new Date(deadlineTo);

                return matchProject && matchResponsible && matchRevisedBy && matchStatus && 
                       matchPriority && matchSearch && matchStartDateFrom && matchStartDateTo && 
                       matchEndDateFrom && matchEndDateTo && matchDeadlineFrom && matchDeadlineTo;
            });
        }

        function updateStatistics() {
            const tasks = getFilteredTasks();
            
            document.getElementById('totalTasks').textContent = tasks.length;
            document.getElementById('inProgressTasks').textContent = 
                tasks.filter(t => t['Status'] === 'In Progress').length;
            document.getElementById('completedTasks').textContent = 
                tasks.filter(t => t['Status'] === 'Completed').length;
            document.getElementById('notStartedTasks').textContent = 
                tasks.filter(t => t['Status'] === 'Not Started').length;
            document.getElementById('onHoldTasks').textContent = 
                tasks.filter(t => t['Status'] === 'On Hold').length;
            const urgentTasks = tasks.filter(isUrgent).length;
            document.getElementById('urgentTasks').textContent = urgentTasks;
        }

        function isUrgent(task) {
            const startDate = parseDate(task['Start Date']);
            const endDate = parseDate(task['End Date']);
            const deadline = parseDate(task['Deadline']);
            const status = task['Status'];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const threeDays = 3 * 24 * 60 * 60 * 1000;

            if (startDate) {
                const daysToStart = startDate - today;
                if (daysToStart >= 0 && daysToStart <= threeDays && status !== 'Completed') return true;
            }

            if (endDate) {
                const daysToEnd = endDate - today;
                if (daysToEnd >= 0 && daysToEnd <= threeDays && status !== 'Completed') return true;
            }

            if (deadline) {
                const daysToDeadline = deadline - today;
                if (daysToDeadline >= 0 && daysToDeadline <= threeDays && status !== 'Completed') return true;
            }

            return false;
        }

        function getUrgencyReason(task) {
            const startDate = parseDate(task['Start Date']);
            const endDate = parseDate(task['End Date']);
            const deadline = parseDate(task['Deadline']);
            const status = (task['Status'] || '').trim().toLowerCase();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const threeDays = 3 * 24 * 60 * 60 * 1000;

            
            const reasons = [];

            if (startDate) {
                const daysToStart = Math.ceil((startDate - today) / (24 * 60 * 60 * 1000));
                if (daysToStart >= 0 && daysToStart <= 3 ) {
                    reasons.push(`Starts in ${daysToStart} day${daysToStart !== 1 ? 's' : ''}`);
                }
            }

            if (endDate) {
                const daysToEnd = Math.ceil((endDate - today) / (24 * 60 * 60 * 1000));
                if (daysToEnd >= 0 && daysToEnd <= 3 ) {
                    reasons.push(`Ends in ${daysToEnd} day${daysToEnd !== 1 ? 's' : ''}`);
                }
            }

            if (deadline) {
                const daysToDeadline = Math.ceil((deadline - today) / (24 * 60 * 60 * 1000));
                if (daysToDeadline >= 0 && daysToDeadline <= 3 ) {
                    reasons.push(`Deadline in ${daysToDeadline} day${daysToDeadline !== 1 ? 's' : ''}`);
                }
            }

            return reasons.join(', ');
        }

        function renderUrgentTasks() {
            const urgentTasks = getFilteredTasks().filter(isUrgent);
            const container = document.getElementById('urgentTasksList');

            if (urgentTasks.length === 0) {
                container.innerHTML = '<div class="no-urgent-tasks">‚úÖ No urgent tasks at this time</div>';
                return;
            }

            container.innerHTML = urgentTasks.map(task => `
                <div class="urgent-task-item">
                    <div class="urgent-task-header">
                        <div class="urgent-task-title">${task['Task Name'] || 'Untitled Task'}</div>
                        <span class="urgent-badge">${getUrgencyReason(task)}</span>
                    </div>
                    <div class="urgent-task-project">üìÅ ${task['Project Name'] || 'No Project'}</div>
                    <div class="urgent-task-details">
                        <span>üë§ ${task['Responsible'] || 'Unassigned'}</span>
                        <span>üìÖ Start: ${formatDate(task['Start Date'])}</span>
                        <span>üèÅ Note: ${task['Notes'] || 'No Notes'}</span>
                        ${task['Deadline'] ? `<span>‚è∞ Deadline: ${formatDate(task['Deadline'])}</span>` : ''}
                        <span class="priority-badge ${getPriorityClass(task['Priority'])}">${task['Priority'] || 'Medium'}</span>
                        <span class="status-badge ${getStatusClass(task['Status'])}">${task['Status'] || 'Not Started'}</span>
                    </div>
                </div>
            `).join('');
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : date;
        }

        function formatDate(dateStr) {
            const date = parseDate(dateStr);
            if (!date) return '-';
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function getStatusClass(status) {
            const statusMap = {
                'Not Started': 'status-not-started',
                'In Progress': 'status-in-progress',
                'Completed': 'status-completed',
                'On Hold': 'status-on-hold'
            };
            return statusMap[status] || 'status-not-started';
        }

        function getPriorityClass(priority) {
            const priorityMap = {
                'High': 'priority-high',
                'Medium': 'priority-medium',
                'Low': 'priority-low'
            };
            return priorityMap[priority] || 'priority-low';
        }

        function renderTable() {
            const tasks = getFilteredTasks();
            const tbody = document.getElementById('taskTableBody');
            
            document.getElementById('taskCount').textContent = `${tasks.length} tasks`;

            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 30px;">No tasks found matching your filters</td></tr>';
                return;
            }

            tbody.innerHTML = tasks.map(task => {
                const urgent = isUrgent(task) ? '<span class="urgent-indicator">üî•</span>' : '';
                const progress = parseInt(task['Progress (%)']) || 0;

                return `
                    <tr>
                        <td><strong>${task['Project Name'] || '-'}</strong></td>
                        <td>${urgent} ${task['Task Name'] || '-'}</td>
                        <td>${task['Responsible'] || '-'}</td>
                        <td>${task['Revised by'] || '-'}</td>
                        <td>${formatDate(task['Start Date'])}</td>
                        <td>${formatDate(task['End Date'])}</td>
                        <td>${formatDate(task['Deadline'])}</td>
                        <td><span class="status-badge ${getStatusClass(task['Status'])}">${task['Status'] || '-'}</span></td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <small>${progress}%</small>
                        </td>
                        <td><span class="priority-badge ${getPriorityClass(task['Priority'])}">${task['Priority'] || '-'}</span></td>
                    </tr>
                `;
            }).join('');

            updateStatistics();
        }

        function renderGanttChart() {
            const tasks = getFilteredTasks().filter(task => 
                task['Start Date'] && task['End Date']
            );

            if (tasks.length === 0) {
                document.getElementById('gantt-chart').innerHTML = '<div style="padding: 30px; text-align: center;">No tasks with valid dates to display in Gantt chart</div>';
                return;
            }

            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Task ID');
            data.addColumn('string', 'Task Name');
            data.addColumn('string', 'Resource');
            data.addColumn('date', 'Start Date');
            data.addColumn('date', 'End Date');
            data.addColumn('number', 'Duration');
            data.addColumn('number', 'Percent Complete');
            data.addColumn('string', 'Dependencies');

            tasks.forEach((task, index) => {
                const startDate = parseDate(task['Start Date']);
                const endDate = parseDate(task['End Date']);
                const progress = parseInt(task['Progress (%)']) || 0;

                if (startDate && endDate) {
                    data.addRows([[
                        `task${index}`,
                        `${task['Project Name']}: ${task['Task Name']}`,
                        task['Responsible'] || '',
                        startDate,
                        endDate,
                        null,
                        progress,
                        null
                    ]]);
                }
            });

            const options = {
                height: Math.max(400, tasks.length  * 45),
                gantt: {
                    trackHeight: 40,
                    criticalPathEnabled: false,
                    innerGridHorizLine: {
                        stroke: '#ffe0b2',
                        strokeWidth: 2
                    },
                    innerGridTrack: {fill: '#fff9e6'},
                    innerGridDarkTrack: {fill: '#fff3cc'}
                }
            };

            const chart = new google.visualization.Gantt(document.getElementById('gantt-chart'));
            chart.draw(data, options);
        }


        function renderProjectCards() {
            const tasks = getFilteredTasks();
            const projectsGrid = document.getElementById('projectsGrid');
            
            // Group tasks by project
            const projectGroups = {};
            tasks.forEach(task => {
                const projectName = task['Project Name'] || 'Unassigned';
                if (!projectGroups[projectName]) {
                    projectGroups[projectName] = [];
                }
                projectGroups[projectName].push(task);
            });
            
            // If no projects
            if (Object.keys(projectGroups).length === 0) {
                projectsGrid.innerHTML = '<p style="text-align: center; padding: 30px; color: #666;">No projects to display</p>';
                return;
            }
            
            // Generate cards for each project
            const cards = Object.keys(projectGroups).map(projectName => {
                const projectTasks = projectGroups[projectName];
                const projectStatus = calculateProjectStatus(projectTasks);
                
                return createProjectCard(projectName, projectTasks, projectStatus);
            }).join('');
            projectsGrid.innerHTML = cards;
            Object.keys(projectGroups).forEach(projectName => {
                
                function changeFilterName(name) {
                    document.getElementById('projectFilter').value = name;
                    document.getElementById('projectFilter').dispatchEvent(new Event('change'));
                    
                }
            document.getElementById(projectName).addEventListener('click', () => changeFilterName(projectName));
            document.getElementById(projectName).addEventListener('click', () => console.log(`Clicked on project: ${projectName}`));
            });
            // function changeFilterName(name) {
            //         document.getElementById('projectFilter').value = name;
            //         document.getElementById('projectFilter').dispatchEvent(new Event('change'));   
            //     }
            
            // document.getElementById(projectName).addEventListener('click', () => changeFilterName(projectName));
            // document.getElementById(projectName).addEventListener('click', () => console.log(`Clicked on project: ${projectName}`));
    
    
}

function calculateProjectStatus(tasks) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    let tasksWithin3Days = [];
    let tasksWithin7Days = [];
    let allTasksStatus = 'green';
    
    tasks.forEach(task => {
        const deadline = parseDate(task['Deadline']);
        
        if (deadline) {
            const daysUntilDeadline = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
            
            if (daysUntilDeadline >= 0 && daysUntilDeadline <= 3) {
                tasksWithin3Days.push({
                    task: task,
                    days: daysUntilDeadline
                });
            } else if (daysUntilDeadline > 3 && daysUntilDeadline <= 7) {
                tasksWithin7Days.push({
                    task: task,
                    days: daysUntilDeadline
                });
            }
        }
    });
    
    // Determine overall status
    if (tasksWithin3Days.length > 0) {
        allTasksStatus = 'red';
    } else if (tasksWithin7Days.length > 0) {
        allTasksStatus = 'yellow';
    }
    
    return {
        status: allTasksStatus,
        tasksWithin3Days: tasksWithin3Days,
        tasksWithin7Days: tasksWithin7Days,
        totalTasks: tasks.length,
        completedTasks: tasks.filter(t => t['Status'] === 'Completed').length,
        inProgressTasks: tasks.filter(t => t['Status'] === 'In Progress').length
    };
}

function createProjectCard(projectName, tasks, status) {
    const { status: statusColor, tasksWithin3Days, tasksWithin7Days, totalTasks, completedTasks, inProgressTasks } = status;
    
    // Generate note message
    let noteMessage = '';
    let noteClass = 'success';
    
    if (tasksWithin3Days.length > 0) {
        noteClass = 'danger';
        noteMessage = `‚ö†Ô∏è <strong>Urgent:</strong> ${tasksWithin3Days.length} task${tasksWithin3Days.length > 1 ? 's' : ''} with deadline${tasksWithin3Days.length > 1 ? 's' : ''} within the next 3 days`;
    } else if (tasksWithin7Days.length > 0) {
        noteClass = 'warning';
        noteMessage = `‚è∞ <strong>Upcoming:</strong> ${tasksWithin7Days.length} task${tasksWithin7Days.length > 1 ? 's' : ''} with deadline${tasksWithin7Days.length > 1 ? 's' : ''} within the next 7 days`;
    } else {
        noteMessage = `‚úÖ <strong>On Track:</strong> No urgent deadlines in the next 7 days`;
    }
    
    // Calculate progress percentage
    const progressPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
    
    return `
        <div class="project-card status-${statusColor}" id="${projectName}">
            <div class="project-card-header">
                <div class="project-card-title">${projectName}</div>
                <div class="project-status-indicator ${statusColor}"></div>
            </div>
            
            <div class="project-card-body">
                <div class="project-card-note ${noteClass}">
                    ${noteMessage}
                </div>
                
                <div class="project-stats">
                    <div class="project-stat-item">
                        <span class="project-stat-label">Total Tasks</span>
                        <span class="project-stat-value">${totalTasks}</span>
                    </div>
                    <div class="project-stat-item">
                        <span class="project-stat-label">In Progress</span>
                        <span class="project-stat-value">${inProgressTasks}</span>
                    </div>
                    <div class="project-stat-item">
                        <span class="project-stat-label">Completed</span>
                        <span class="project-stat-value">${completedTasks}</span>
                    </div>
                    <div class="project-stat-item">
                        <span class="project-stat-label">Progress</span>
                        <span class="project-stat-value">${progressPercentage}%</span>
                    </div>
                    <button class="btn btn-sm btn-primary" style="margin-left: 35px;" onclick="editTasksFromProject('${projectName}')">Edit</button>
                </div>
            </div>
            
            <div class="project-card-footer">
                ${tasksWithin3Days.length > 0 ? 
                    `Tasks due soon: ${tasksWithin3Days.map(t => t.task['Task Name']).slice(0, 3).join(', ')}${tasksWithin3Days.length > 3 ? '...' : ''}` 
                    : tasksWithin7Days.length > 0 ? 
                    `Upcoming tasks: ${tasksWithin7Days.map(t => t.task['Task Name']).slice(0, 3).join(', ')}${tasksWithin7Days.length > 3 ? '...' : ''}` 
                    : 'All tasks on schedule'}
            </div>
        </div>
    `;
}
    function editTasksFromProject(projectName) {
        // const baseUrl = "https://docs.google.com/spreadsheets/d/YOUR_SPREADSHEET_ID/edit"; // Replace with your spreadsheet URL
        // const url = `${baseUrl}#gid=0&fvid=0&range=A1:Z1000&filter=Project Name='${encodeURIComponent(projectName)}'`;
        // window.open(url, '_blank');
        window.location.href = `16115-35.html?ProName=${encodeURIComponent(projectName)}`;
    }
// Function to sort the table based on the selected column
        function sortTable(columnIndex) {
            const tbody = document.getElementById('taskTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            const ascending = currentSort.column === columnIndex ? !currentSort.ascending : true;
            currentSort = { column: columnIndex, ascending };

            rows.sort((a, b) => {
                const aText = a.cells[columnIndex].textContent.trim();
                const bText = b.cells[columnIndex].textContent.trim();
                
                const comparison = aText.localeCompare(bText, undefined, { numeric: true });
                return ascending ? comparison : -comparison;
            });

            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        function clearFilters() {
            document.getElementById('projectFilter').value = '';
            document.getElementById('responsibleFilter').value = '';
            document.getElementById('revisedByFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('priorityFilter').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('startDateFrom').value = '';
            document.getElementById('startDateTo').value = '';
            document.getElementById('endDateFrom').value = '';
            document.getElementById('endDateTo').value = '';
            document.getElementById('deadlineFrom').value = '';
            document.getElementById('deadlineTo').value = '';
            
            if (allTasks.length > 0) {
                renderTable();
                renderGanttChart();
                renderUrgentTasks();
                 renderProjectCards();
            }
        }

        // Event listeners
        document.getElementById('projectFilter').addEventListener('change', () => {
            renderTable();
            renderGanttChart();
            renderUrgentTasks();
             renderProjectCards();
        });
        
        document.getElementById('responsibleFilter').addEventListener('change', () => {
            renderTable();
            renderGanttChart();
            renderUrgentTasks();
             renderProjectCards();
        });
        
        document.getElementById('revisedByFilter').addEventListener('change', () => {
            renderTable();
            renderGanttChart();
            renderUrgentTasks();
             renderProjectCards();
        });
        
        document.getElementById('statusFilter').addEventListener('change', () => {
            renderTable();
            renderGanttChart();
            renderUrgentTasks();
             renderProjectCards();
        });
        
        document.getElementById('priorityFilter').addEventListener('change', () => {
            renderTable();
            renderGanttChart();
            renderUrgentTasks();
             renderProjectCards();
        });
        
        document.getElementById('searchInput').addEventListener('input', () => {
            renderTable();
            renderGanttChart();
            renderUrgentTasks();
             renderProjectCards();
        });

        // Date filter event listeners
        document.getElementById('startDateFrom').addEventListener('change', () => {
            renderTable();
            renderGanttChart();
            renderUrgentTasks();
             renderProjectCards();
        });
        
        document.getElementById('startDateTo').addEventListener('change', () => {
            renderTable();
            renderGanttChart();
            renderUrgentTasks();
             renderProjectCards();
        });
        
        document.getElementById('endDateFrom').addEventListener('change', () => {
            renderTable();
            renderGanttChart();
            renderUrgentTasks();
             renderProjectCards();
        });
        
        document.getElementById('endDateTo').addEventListener('change', () => {
            renderTable();
            renderGanttChart();
            renderUrgentTasks();
             renderProjectCards();
        });
        
        document.getElementById('deadlineFrom').addEventListener('change', () => {
            renderTable();
            renderGanttChart();
            renderUrgentTasks();
             renderProjectCards();
        });
        
        document.getElementById('deadlineTo').addEventListener('change', () => {
            renderTable();
            renderGanttChart();
            renderUrgentTasks();
             renderProjectCards();
        });

        // Auto-refresh every 5 minutes
        setInterval(() => {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            if (apiUrl && allTasks.length > 0) {
                loadData();
            }
        }, 900000);
        loadData();
        // Disable right-click
document.addEventListener('contextmenu', event => event.preventDefault());

// Disable specific key combinations
document.addEventListener('keydown', event => {
  // F12
  if (event.key === 'F12') {
    event.preventDefault();
  }

  // Ctrl + Shift + I
  if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'i') {
    event.preventDefault();
  }

  // Ctrl + Shift + J (console)
  if (event.ctrlKey && event.shiftKey && event.key.toLowerCase() === 'j') {
    event.preventDefault();
  }

  // Ctrl + U (view source)
  if (event.ctrlKey && event.key.toLowerCase() === 'u') {
    event.preventDefault();
  }

  // Ctrl + S (save page)
  if (event.ctrlKey && event.key.toLowerCase() === 's') {
    event.preventDefault();
  }

  // Ctrl + C (copy)
  if (event.ctrlKey && event.key.toLowerCase() === 'c') {
    event.preventDefault();
  }

 if (event.ctrlKey && event.key.toLowerCase() === 'p') {
    event.preventDefault();
  }
});
    </script>
</body>
</html>
